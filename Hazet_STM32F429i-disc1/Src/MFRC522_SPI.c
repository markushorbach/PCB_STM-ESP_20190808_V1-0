/*		NXP MFRC522 SPI Mifare driver
 *		for STM32 CubeMX projects
 *      Author: Markus Horbach
 *      Version 1.0
 *      Date : 26.08.2019
 */
#include "MFRC522_SPI.h"

uint8_t data_SelfTest_01[64] ={
		0x00, 0xC6, 0x37, 0xD5, 0x32, 0xB7, 0x57, 0x0C,
		0xC2, 0xD8, 0x7C, 0x4D, 0xD9, 0x70, 0xC7, 0x73,
		0x10, 0xE6, 0xD2, 0xAA, 0x5E, 0xA1, 0x3E, 0x5A,
		0x14, 0xAF, 0x30, 0x61, 0xC9, 0x70, 0xDB, 0x2E,
		0x64, 0x22, 0x72, 0xB5, 0xBD, 0x65, 0xF4, 0xEC,
		0x22, 0xBC, 0xD3, 0x72, 0x35, 0xCD, 0xAA, 0x41,
		0x1F, 0xA7, 0xF3, 0x53, 0x14, 0xDE, 0x7E, 0x02,
		0xD9, 0x0F, 0xB5, 0x5E, 0x25, 0x1D, 0x29, 0x79};

uint8_t data_SelfTest_02[64] ={
		0x00, 0xEB, 0x66, 0xBA, 0x57, 0xBF, 0x23, 0x95,
		0xD0, 0xE3, 0x0D, 0x3D, 0x27, 0x89, 0x5C, 0xDE,
		0x9D, 0x3B, 0xA7, 0x00, 0x21, 0x5B, 0x89, 0x82,
		0x51, 0x3A, 0xEB, 0x02, 0x0C, 0xA5, 0x00, 0x49,
		0x7C, 0x84, 0x4D, 0xB3, 0xCC, 0xD2, 0x1B, 0x81,
		0x5D, 0x48, 0x76, 0xD5, 0x71, 0x61, 0x21, 0xA9,
		0x86, 0x96, 0x83, 0x38, 0xCF, 0x9D, 0x5B, 0x6D,
		0xDC, 0x15, 0xBA, 0x3E, 0x7D, 0x95, 0x3B, 0x2F};

void MFRC522_HardReset(void){
	HAL_GPIO_WritePin(MFRC522_RST_Port, MFRC522_RST_Pin, GPIO_PIN_RESET);
	HAL_Delay(1);
	HAL_GPIO_WritePin(MFRC522_RST_Port, MFRC522_RST_Pin, GPIO_PIN_SET);
	HAL_Delay(1);
}

void MFRC522_SoftReset(void){
	MFRC522_SendCMD(MFRC522_CMD_RESETPHASE);
}

uint8_t MFRC522_Read_Register(uint8_t addr){
	uint8_t datasend[2] = {(addr *2 + 0x80 ), MFRC522_DUMMY};
	uint8_t datarecv[2] = {MFRC522_DUMMY, MFRC522_DUMMY};

	HAL_SPI_TransmitReceive(MFRC522_SPI, &datasend[0], &datarecv[0], 2, 10);
	return datarecv[1];
}

void MFRC522_Write_Register(uint8_t addr, uint8_t val){

	uint8_t datasend[2] = {((addr *2)), val};
	HAL_SPI_Transmit(MFRC522_SPI, &datasend[0], 2, 1);
}

void MFRC522_SendCMD(uint8_t cmd){
	if (cmd < 16) {
		MFRC522_Write_Register(MFRC522_REG_COMMAND, cmd);
	}
}

void MFRC522_Init(void){
	MFRC522_HardReset();

	MFRC522_Write_Register(MFRC522_REG_T_MODE, 0x8D);
	MFRC522_Write_Register(MFRC522_REG_T_PRESCALER, 0x3E);
	MFRC522_Write_Register(MFRC522_REG_T_RELOAD_L, 30);
	MFRC522_Write_Register(MFRC522_REG_T_RELOAD_H, 0);

	/* 48dB gain */
	MFRC522_Write_Register(MFRC522_REG_RF_CFG, 0x70);

	MFRC522_Write_Register(MFRC522_REG_TX_AUTO, 0x40);
	MFRC522_Write_Register(MFRC522_REG_MODE, 0x3D);

	TM_MFRC522_AntennaOn();
}
uint8_t MFRC522_ChipVersion(void){

	return MFRC522_Read_Register(MFRC522_REG_VERSION);
}
void MFRC522_SelfTest(void){

}


